---
const { class: customClass } = Astro.props;
---

<section class={`page-intro page ${customClass}`}>
  <div class="grid gap-4 page content-baseline lg:grid-cols-2 lg:gap-12">
    <div class="col-1 col self-baseline">
      <slot name="column-one" />
    </div>
    <div class="self-auto col-2 col">
      <slot name="column-two" />
    </div>
  </div>
</section>

<style>
  .col-1 {
    font-size: var(--fs-3);
    line-height: 112.5%;
    color: var(--text);
    opacity: 0.8;
  }

  .col-2 {
    font-size: calc(2 * var(--fs-0));
    line-height: 112.5%;
    font-weight: 600;
    letter-spacing: -0.0125em;
    opacity: 0.8;
  }

  .page .col-1 {
    font-size: var(--fs-1);
    line-height: 112.5%;
    /* font-weight:600; */
    /* letter-spacing: -0.0125em; */
    color: var(--text);
  }
  .page .col-2 {
    font-size: var(--fs-0);
    line-height: 112.5%;
    color: var(--text);

    font-weight: 400;
  }

  section div > div {
    max-width: 70ch;
  }

  :global(.home .col h3) {
    margin-bottom: 2rem;
    font-size: var(--fs-4);
    line-height: 95%;
    font-weight: 400;
  }

  :global(.home .col h4) {
    font-size: var(--fs-2);
    font-weight: 400;
  }

  :global(.home .col p) {
    font-size: var(--fs-1);
    line-height: 112.5%;
  }

  /* Link styling in PageIntro */
  :global(.page-intro a) {
    text-decoration: underline;
   
    color: inherit;
    transition: opacity 0.2s ease;
  }

  :global(.page-intro a:hover) {
    opacity: 0.7;
  }

  /* Video hover link styling */
  :global(.link-with-video) {
    cursor: pointer;
  }

  /* Video preview container */
  :global(.video-hover-preview) {
    position: fixed;
    width: 200px;
    max-width: 200px;
    height: auto;
    pointer-events: none;
    z-index: 9999;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    opacity: 0;
    transform: scale(1.05);
    transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
  }

  :global(.video-hover-preview.visible) {
    opacity: 1;
    transform: scale(1);
  }

  :global(.video-hover-preview video) {
    width: 100%;
    height: auto;
    object-fit: contain;
    display: block;
  }
</style>

<script>
  function initVideoHover() {
    const win = window as unknown as {
      __videoHoverState?: {
        videoElement: HTMLVideoElement | null;
        videoContainer: HTMLDivElement | null;
        currentLink: HTMLElement | null;
        hideTimeout: number | null;
        tracking: boolean;
      };
    };
    const state =
      win.__videoHoverState ||
      (win.__videoHoverState = {
        videoElement: null,
        videoContainer: null,
        currentLink: null,
        hideTimeout: null,
        tracking: false,
      });

    const linksWithVideo = document.querySelectorAll(
      'a[data-video-url]:not([data-video-hover-bound])',
    );

    function ensureVideoElements() {
      if (!state.videoContainer) {
        state.videoContainer = document.createElement('div');
        state.videoContainer.className = 'video-hover-preview';
        document.body.appendChild(state.videoContainer);
      }

      if (!state.videoElement) {
        state.videoElement = document.createElement('video');
        state.videoElement.muted = true;
        state.videoElement.loop = true;
        state.videoElement.autoplay = true;
        state.videoElement.playsInline = true;
        state.videoElement.setAttribute('playsinline', '');
        state.videoContainer.appendChild(state.videoElement);
      }
    }

    function setVideoSource(videoUrl: string) {
      ensureVideoElements();
      if (!state.videoElement || !state.videoContainer) return;

      if (state.videoElement.src !== videoUrl) {
        state.videoElement.src = videoUrl;
      }

      state.videoElement.play().catch(() => {
        // Keep container visible even if autoplay fails (e.g. remote restrictions).
      });
    }

    function updateVideoPosition(e: MouseEvent) {
      if (!state.videoContainer) return;

      const offsetX = 20;
      const offsetY = 20;
      const rect = state.videoContainer.getBoundingClientRect();
      const videoWidth = rect.width || 200;
      const videoHeight = rect.height || 112;
      const windowWidth = window.innerWidth;
      const windowHeight = window.innerHeight;

      let left = e.clientX + offsetX;
      let top = e.clientY - videoHeight - offsetY;

      // Zorg dat video niet buiten scherm valt
      if (left + videoWidth > windowWidth) {
        left = e.clientX - videoWidth - offsetX;
      }
      if (top < 0) {
        top = e.clientY + offsetY;
      }

      state.videoContainer.style.left = `${left}px`;
      state.videoContainer.style.top = `${top}px`;
    }

    function showVideo(link: Element | HTMLElement, videoUrl: string) {
      state.currentLink = link as HTMLElement;
      if (state.hideTimeout) {
        clearTimeout(state.hideTimeout);
        state.hideTimeout = null;
      }

      setVideoSource(videoUrl);

      if (state.videoContainer) {
        requestAnimationFrame(() => {
          state.videoContainer?.classList.add('visible');
        });
      }

      if (!state.tracking) {
        document.addEventListener('mousemove', updateVideoPosition);
        state.tracking = true;
      }
    }

    function hideVideo() {
      state.currentLink = null;

      if (state.videoContainer) {
        state.videoContainer.classList.remove('visible');
      }

      if (state.hideTimeout) {
        clearTimeout(state.hideTimeout);
      }

      state.hideTimeout = window.setTimeout(() => {
        if (state.videoElement) {
          state.videoElement.pause();
          state.videoElement = null;
        }
        if (state.videoContainer) {
          state.videoContainer.remove();
          state.videoContainer = null;
        }
      }, 200);

      if (state.tracking) {
        document.removeEventListener('mousemove', updateVideoPosition);
        state.tracking = false;
      }
    }

    // Voeg event listeners toe aan alle links met video
    linksWithVideo.forEach((link) => {
      const videoUrl = link.getAttribute('data-video-url');
      if (!videoUrl) return;

      const htmlLink = link as HTMLElement;
      htmlLink.dataset.videoHoverBound = 'true';
      htmlLink.addEventListener('mouseenter', () => {
        showVideo(htmlLink, videoUrl);
      });

      htmlLink.addEventListener('mouseleave', () => {
        hideVideo();
      });
    });
  }

  // Initialiseer bij page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initVideoHover);
  } else {
    initVideoHover();
  }

  // Herinitialiseer bij Astro page navigation
  document.addEventListener('astro:page-load', initVideoHover);
  document.addEventListener('astro:after-swap', initVideoHover);
</script>
