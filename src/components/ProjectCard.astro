---
// Import Components
import { Image, getImage } from 'astro:assets';
import TagGroup from '../components/TagGroup.astro'
import {slugify} from '../lib/utils.js';
import { urlForImage } from '../sanity/lib/image';

// Type Definitions
type Services = {
  title: string
}

type ProjectProps = {
  clientname?: string
  title?: string
  imgsrc?: string
  imgalt?: string
  vidsrc?: string
  link?: string
  size?: string
  services?: Services[]
  fitCards?: boolean
  aspectRatio?: string
  // Sanity specific props
  _type?: string
  _key?: string
  thumbnail?: any
  client?: any
}

// Defaults
const { 
  clientname, 
  title, 
  imgsrc, 
  imgalt = '', 
  vidsrc, 
  link, 
  size, 
  services, 
  fitCards,
  aspectRatio = '16:9',
  // Sanity props
  _type,
  _key,
  thumbnail,
  client
} = Astro.props as ProjectProps

// DEBUG: Log project card data
if (import.meta.env.DEV) {
  console.log('üé® ProjectCard received:', {
    title,
    clientname,
    size,
    imgsrc,
    imgalt,
    vidsrc,
    servicesCount: services?.length || 0,
    link,
    hasThumbnail: !!thumbnail
  });
}

// Process Sanity data
const processedProps = {
  clientname: client?.title || clientname,
  title: title,
  imgsrc: thumbnail?.image?.asset?.url || imgsrc,
  imgalt: thumbnail?.alt || imgalt,
  vidsrc: thumbnail?.video || vidsrc,
  link: link,
  size: thumbnail?.size || size,
  services: services || [],
  fitCards: fitCards,
  aspectRatio: thumbnail?.aspectRatio || aspectRatio
};

if (import.meta.env.DEV) {
  console.log('üé® Processed Sanity props:', processedProps);
}

// Use processed props
const { 
  clientname: finalClientname, 
  title: finalTitle, 
  imgsrc: finalImgsrc, 
  imgalt: finalImgalt, 
  vidsrc: finalVidsrc, 
  link: finalLink, 
  size: finalSize, 
  services: finalServices, 
  fitCards: finalFitCards 
} = processedProps;

// Get final aspect ratio
const finalAspectRatio = processedProps.aspectRatio || aspectRatio;
let cardclasses = ''

if (finalFitCards !== true) {
  if (finalSize) {
    switch (finalSize) {
      case 'small':
        cardclasses = 'lg:col-span-4'
        break
      case 'large':
        cardclasses = 'lg:col-span-8'
        break
      case 'full':
        cardclasses = 'lg:col-span-12'
        break
      default:
        cardclasses = 'lg:col-span-6'
    }
  }
} else {
  cardclasses = 'lg:col-span-2'
}

const serviceTitles = finalServices?.map(service => slugify(service.title)).join(' ') || '';

// Generate image URL for Sanity
let imageSrc = finalImgsrc;
if (thumbnail?.image?.asset) {
  try {
    imageSrc = urlForImage(thumbnail.image)?.width(800).height(600).url() || '';
  } catch (error) {
    if (import.meta.env.DEV) {
      console.warn('‚ö†Ô∏è Failed to generate Sanity image URL:', error);
    }
    imageSrc = finalImgsrc; // Fallback to direct URL
  }
}

// Aspect ratio CSS class
const aspectRatioClass = `aspect-${finalAspectRatio.replace(':', '-')}`;

const theImage:any = imageSrc? await getImage({
    src: imageSrc, 
    inferSize: true, 
    widths: [540, 960, 1440, 1920],
    sizes: "(max-width: 360px) 540px, (max-width: 720px) 960px, (max-width: 1600px) 1440px, 1920px",
    alt: finalImgalt || "",
    title: finalTitle || "",
    format: 'webp'
  }) : "";
---

<div class={`project-card ${cardclasses}`} data-services={serviceTitles}>
  <div class={`overflow-hidden project-media ${aspectRatioClass}`}>
    {
      finalVidsrc ? ( // if vidsrc is set, show video with poster image
        <div class="project-video">
          <video
            preload="metadata"
            tabindex="-1"
            disablepictureinpicture
            playsinline
            loop
            title={finalTitle}
            src={finalVidsrc}
            poster={theImage?.src || imageSrc}
            autoplay={true}
            muted
          />
        </div>
      ) : (
        imageSrc && ( // if no video, show image
          <div class="project-image">
            <Image 
              src={imageSrc}
              inferSize
              widths={[540, 960, 1440, 1920]}
              sizes={`(max-width: 360px) 540px, (max-width: 720px) 960px, (max-width: 1600px) 1440px, 1920px`}
              format='avif'
              alt={finalImgalt || ""}
              title={finalTitle || ""}
            />
          </div>
        )
      )
    }
  </div>

  <div class="project-content">
    <div class="flex justify-between pt-6 mb-0 align-middle project-meta">
      {finalClientname && <h3 class="font-medium opacity-80 project-client self-baseline">{finalClientname}</h3>}
      {finalServices && <TagGroup tags={finalServices} />}
    </div>

    {
      finalTitle && (
        <h2 class="leading-4 project-title">
          <a href={finalLink} class="project-link" data-astro-reload>
            {finalTitle}
          </a>
        </h2>
      )
    }
  </div>

  <style is:global>

    .project-card {    
      position: relative;
      
      color: var(--font-color);
      transition: transform 0.4s var(--easing-easeOutExpo);
    }

    .project-client {
      font-size: var(--fs--3);
      letter-spacing: -0.0125em;
      line-height: 112.5%;
    }

    .project-title {
      font-size: var(--fs-2);
      letter-spacing: -0.0125em;
      line-height: 100%;
      font-weight:300;
      margin:0;
      padding:0;
    }

    /* Remove duplicate width rule - now handled by aspect ratio CSS */

    .project-title {
      /* text-edge: cap alphabetic; */
    }

    /* Aspect ratio classes */
    .aspect-16-9 { aspect-ratio: 16 / 9; }
    .aspect-5-4 { aspect-ratio: 5 / 4; }
    .aspect-4-3 { aspect-ratio: 4 / 3; }
    .aspect-3-2 { aspect-ratio: 3 / 2; }
    .aspect-1-1 { aspect-ratio: 1 / 1; }
    .aspect-2-3 { aspect-ratio: 2 / 3; }
    .aspect-3-4 { aspect-ratio: 3 / 4; }
    .aspect-4-5 { aspect-ratio: 4 / 5; }
    .aspect-9-16 { aspect-ratio: 9 / 16; }

    /* Ensure media content fills the aspect ratio container */
    .project-media img,
    .project-media video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Ensure video container fills the aspect ratio */
    .project-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
  </style>
</div>
