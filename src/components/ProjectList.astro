---
import ProjectCard from '../components/ProjectCard.astro';

const { projects, layout, fitCards } = Astro.props;

// DEBUG: Log projects data
if (import.meta.env.DEV) {
  console.log(
    'üìÅ ProjectList received projects:',
    JSON.stringify(projects, null, 2),
  );
  console.log('üìÅ Projects count:', projects?.length || 0);
}

// Process Sanity projects
const projectCards = projects.map((project: any) => {
  if (import.meta.env.DEV) {
    console.log(`üìÅ Processing project "${project.title}":`, {
      _type: project._type,
      hasKey: !!project._key,
      hasThumbnail: !!project.thumbnail,
      hasImage: !!project.thumbnail?.image,
    });
  }

  // Sanity data structure
  // Pass through raw data - let ProjectCard handle URL generation to avoid duplication
  return {
    title: project.title || '',
    clientname: project.client?.title || '',
    size: project.thumbnail?.size?.toString() || '',
    // Don't pre-generate image URL here - ProjectCard will handle it more efficiently
    // This avoids duplication and allows ProjectCard to optimize image sizes per use case
    imgsrc: '', // Let ProjectCard generate from thumbnail
    imgalt: project.thumbnail?.alt || project.title || '',
    vidsrc: project.thumbnail?.video || '',
    services: project.services || [],
    link: `/project/${project.slug}/`,
    aspectRatio: project.thumbnail?.aspectRatio || '16:9',
    // Sanity specific props - these are the source of truth
    _type: project._type,
    _key: project._key,
    thumbnail: project.thumbnail,
    client: project.client,
  };
});

if (import.meta.env.DEV) {
  console.log('üìÅ Processed project cards:', projectCards);
}
---

<section
  class="projects-wrapper page"
  class:list={[
    {
      'layout-grid': layout === 'grid',
      'layout-list': layout !== 'grid',
    },
  ]}
>
  <div class="project-list start grid gap-12 gap-y-8 md:gap-y-12 lg:gap-y-24">
    {
      projectCards &&
        projectCards.map((item: any) => {
          return <ProjectCard {...item} {fitCards} />;
        })
    }
  </div>
</section>

<style is:global>
  .projects-wrapper {
    padding-top: 0;
    padding-bottom: var(--space-6xl);
    min-height: 80vh;
  }

  .layout-grid {
    /* background-color: aqua; */
  }

  .layout-list {
    /* background: yellow; */
  }

  .layout-grid .project-list {
    /* homepage grid */
    /* background-color: blue; */
    /* Mobile: 1 column */
    grid-template-columns: 1fr;
    align-items: start;
  }

  /* Tablet: 2 columns */
  @media (min-width: 768px) {
    .layout-grid .project-list {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }

  /* Desktop: 12 column grid */
  @media (min-width: 1024px) {
    .layout-grid .project-list {
      grid-template-columns: repeat(12, minmax(0, 1fr));
    }
  }

  .layout-list .project-list {
    /* overview grid */
    /* background-color: red; */
    grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
    align-items: start;
  }

  .project-card:hover,
  .project-card:focus-within {
    box-shadow: 0 0 0 0.5rem;
    box-shadow: none;

    cursor: pointer;
  }

  .project-card img,
  .project-card video {
    /* transform: scale(1.0125); */
    transition: all 1.4s var(--easing-easeOutExpo);
    opacity: 0.9;
  }

  .project-card:hover img,
  .project-card:hover video {
    /* transform: scale(1); */
    opacity: 1;
  }
  .project-card:hover {
    /* transform: scale(0.985); */
  }

  .project-content a {
    text-decoration: none !important;
    color: inherit !important;
  }

  .project-content a:focus {
    text-decoration: underline;
  }

  .project-content a::after {
    content: '';
    position: absolute;
    inset: 0;
  }

  .project-card {
    transition: all 0.4s var(--easing-easeOutExpo);
  }
  .project-card:hover {
    opacity: 1;
  }
  .project-card:hover ~ .project-card {
    opacity: 0.75;
  }
  .project-list:hover .project-card:not(:hover) {
    opacity: 0.1;
  }
  .project-list:hover .project-card:not(:hover) {
    opacity: 0.75;
  }

  @media (min-width: 1024px) {
    .layout-list .project-list {
      grid-template-columns: repeat(6, minmax(0, 1fr));
    }
  }
</style>

<script>
  import { inView, animate } from 'motion';

  inView('.project-card .project-media', ({ target }) => {
    target.classList.add('in-view');
  });

  inView('.project-card .project-media', (info) => {
    const controls = animate(
      info.target,
      {
        opacity: [0, 0.75],
        transform: ['translateY(3rem)', 'translateY(0px)'],
      },
      {
        delay: 0.2,
        duration: 0.9,
        easing: [0.16, 1, 0.3, 1],
      },
    );
    // This will fire when the element leaves the viewport
    return (_leaveInfo) => {
      controls.stop();
      animate(
        info.target,
        { opacity: 0, transform: ['translateY(0px)', 'translateY(20px)'] },
        { duration: 0.6 },
      );
    };
  });

  inView('.project-card .project-content', ({ target }) => {
    target.classList.add('in-view');
  });

  inView('.project-card .project-content', (info) => {
    const controls = animate(
      info.target,
      {
        opacity: [0, 1],
        transform: ['translateY(2rem)', 'translateY(0px)'],
      },
      {
        delay: 0.1,
        duration: 0.4,
        easing: [0.16, 1, 0.3, 1],
      },
    );
    // This will fire when the element leaves the viewport
    return (_leaveInfo) => {
      controls.stop();
      animate(
        info.target,
        { opacity: 0, transform: ['translateY(0px)', 'translateY(20px)'] },
        { duration: 0.6 },
      );
    };
  });
</script>
