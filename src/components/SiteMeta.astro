---
import { ClientRouter } from 'astro:transitions';
import { getImageUrl } from '../lib/seo-helpers';

const { title, description, url, image, author, seo } = Astro.props;

// Geen subtitle meer - gebruik alleen de SEO title

// Use SEO data if available, otherwise fallback to props
const seoTitle = seo?.title || title;
const seoDescription = seo?.description || description;
const seoImage = seo?.metaImage || seo?.openGraph?.image || image;
const imageUrl = seoImage?.asset
  ? getImageUrl(seoImage)
  : seoImage?.imageUrl ||
    (Astro.site
      ? `${Astro.site}${seoImage}`
      : seoImage || '/social-preview-image.png');
const fullImageUrl = imageUrl?.startsWith('http')
  ? imageUrl
  : Astro.site
    ? `${Astro.site}${imageUrl}`
    : imageUrl;

// Open Graph
const ogTitle = seo?.openGraph?.title || seoTitle;
const ogDescription = seo?.openGraph?.description || seoDescription;
const ogType = seo?.openGraph?.type || 'website';
const ogSiteName = seo?.openGraph?.siteName || '';

// Fix: Check imageUrl eerst, dan image asset, dan metaImage, dan fallback
let ogImage = '';
if (seo?.openGraph?.imageUrl) {
  // 1. Als imageUrl expliciet is ingesteld, gebruik die
  ogImage = seo.openGraph.imageUrl;
} else if (seo?.openGraph?.image?.asset) {
  // 2. Als er een Sanity Open Graph image asset is, genereer URL
  ogImage = getImageUrl(seo.openGraph.image);
} else if (seo?.metaImage?.asset) {
  // 3. Fallback naar metaImage als die beschikbaar is
  ogImage = getImageUrl(seo.metaImage);
} else {
  // 4. Laatste fallback naar fullImageUrl
  ogImage = fullImageUrl;
}

// Zorg dat ogImage altijd absoluut is voor Open Graph
if (ogImage && !ogImage.startsWith('http')) {
  // Als relatief, maak absoluut met Astro.site of request origin
  const baseUrl = Astro.site || new URL(Astro.request.url).origin;
  ogImage = `${baseUrl}${ogImage.startsWith('/') ? ogImage : `/${ogImage}`}`;
}

// Twitter
const twitterCard = seo?.twitter?.card || 'summary_large_image';
const twitterSite = seo?.twitter?.site || '';
const twitterTitle = seo?.twitter?.title || seoTitle;
const twitterDescription = seo?.twitter?.description || seoDescription;

// Fix: Zelfde logica voor Twitter image
let twitterImage = '';
if (seo?.twitter?.imageUrl) {
  // 1. Als imageUrl expliciet is ingesteld, gebruik die
  twitterImage = seo.twitter.imageUrl;
} else if (seo?.twitter?.image?.asset) {
  // 2. Als er een Sanity Twitter image asset is, genereer URL
  twitterImage = getImageUrl(seo.twitter.image);
} else if (seo?.metaImage?.asset) {
  // 3. Fallback naar metaImage als die beschikbaar is
  twitterImage = getImageUrl(seo.metaImage);
} else {
  // 4. Laatste fallback naar fullImageUrl
  twitterImage = fullImageUrl;
}

// Zorg dat twitterImage altijd absoluut is
if (twitterImage && !twitterImage.startsWith('http')) {
  // Als relatief, maak absoluut met Astro.site of request origin
  const baseUrl = Astro.site || new URL(Astro.request.url).origin;
  twitterImage = `${baseUrl}${twitterImage.startsWith('/') ? twitterImage : `/${twitterImage}`}`;
}

// Canonical URL
const canonicalUrl = seo?.canonicalUrl || url;

// Robots
const robotsContent = [
  seo?.robots?.noIndex ? 'noindex' : 'index',
  seo?.robots?.noFollow ? 'nofollow' : 'follow',
].join(', ');

// Keywords
const keywordsString = seo?.keywords?.join(', ');
---

<!-- General Meta Tags -->
<meta name="title" content={seoTitle} />
{seoDescription && <meta name="description" content={seoDescription} />}
{author && <meta name="author" content={author} />}
{keywordsString && <meta name="keywords" content={keywordsString} />}

<!-- Robots -->
{robotsContent && <meta name="robots" content={robotsContent} />}

<!-- Canonical URL -->
{canonicalUrl && <link rel="canonical" href={canonicalUrl} />}

<!-- Open Graph -->
<meta property="og:title" content={ogTitle} />
{ogDescription && <meta property="og:description" content={ogDescription} />}
<meta property="og:type" content={ogType} />
{url && <meta property="og:url" content={url} />}
{ogImage && <meta property="og:image" content={ogImage} />}
{ogImage && <meta property="og:image:width" content="1200" />}
{ogImage && <meta property="og:image:height" content="630" />}
{ogSiteName && <meta property="og:site_name" content={ogSiteName} />}

<!-- Twitter Card -->
<meta name="twitter:card" content={twitterCard} />
{twitterSite && <meta name="twitter:site" content={twitterSite} />}
<meta name="twitter:title" content={twitterTitle} />
{
  twitterDescription && (
    <meta name="twitter:description" content={twitterDescription} />
  )
}
{twitterImage && <meta name="twitter:image" content={twitterImage} />}

<!-- Page Title -->
<title>{seoTitle}</title>

<ClientRouter />
