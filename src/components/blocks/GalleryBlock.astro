---
// Import Components & Scripts
import { Image } from 'astro:assets';
import { urlForImage } from '../../sanity/lib/image';
import type { SanityImage } from '../../sanity/types';

// Define Types
interface Props {
  title?: string;
  gallery?: SanityImage[];
  layout?: 'grid' | 'masonry';
  columns?: number;
  showCaptions?: boolean;
  showTitle?: boolean;
}

// Define vars
const { title, gallery, layout = 'grid', columns = 3, showCaptions = false, showTitle = false } = Astro.props;

// Calculate optimal image width based on columns
// Page width is ~1400px, divide by columns and add some padding
function getImageWidth(cols: number): number {
  const pageWidth = 1400;
  return Math.floor(pageWidth / cols);
}

const imageWidth = getImageWidth(columns);

// Process gallery images
const processedImages = gallery?.map((image: SanityImage) => {
  let imageUrl = '';
  let imageAlt = '';
  let imageCaption = '';

  if (image?.asset) {
    try {
      imageUrl = urlForImage(image)?.width(imageWidth).url() || '';
      imageAlt = image.alt || '';
      imageCaption = image.caption || '';
    } catch (error) {
      if (import.meta.env.DEV) {
        console.warn('Failed to generate image URL in GalleryBlock:', error);
      }
    }
  }

  return {
    url: imageUrl,
    alt: imageAlt,
    caption: imageCaption,
  };
}).filter(img => img.url) || [];

if (import.meta.env.DEV) {
  console.log('üñºÔ∏è GalleryBlock received:', {
    title,
    layout,
    columns,
    showCaptions,
    imagesCount: processedImages.length,
    galleryCount: gallery?.length || 0
  });
}
---

<!--GalleryBlock-->
<div class="galleryblock page">
  {showTitle && title && <h2 class="galleryblock-title">{title}</h2>}
  
  {layout === 'grid' && (
    <div 
      class="galleryblock-grid grid gap-[var(--gap-default)] grid-cols-1 sm:grid-cols-2"
      style={`--grid-cols: ${columns};`}
    >
      {processedImages.map((img) => (
        <div class="galleryblock-item">
          <Image 
            src={img.url}
            inferSize
            widths={[300, 600, 900, 1200]}
            sizes={`(max-width: 640px) 300px, (max-width: 1024px) 600px, ${imageWidth}px`}
            format="avif"
            alt={img.alt || ''}
            class="galleryblock-image"
          />
          {showCaptions && img.caption && (
            <p class="galleryblock-caption" set:html={img.caption} />
          )}
        </div>
      ))}
    </div>
  )}

  {layout === 'masonry' && (
    <div 
      class="gap-[var(--gap-default)] galleryblock-masonry columns-1 sm:columns-2"
      style={`--columns: ${columns};`}
    >
      {processedImages.map((img) => (
        <div class="mb-[var(--gap-default)] galleryblock-item break-inside-avoid">
          <Image 
            src={img.url}
            inferSize
            widths={[300, 600, 900, 1200]}
            sizes={`(max-width: 640px) 300px, (max-width: 1024px) 600px, ${imageWidth}px`}
            format="avif"
            alt={img.alt || ''}
            class="galleryblock-image"
          />
          {showCaptions && img.caption && (
            <p class="galleryblock-caption" set:html={img.caption} />
          )}
        </div>
      ))}
    </div>
  )}
</div>

<style>
  .galleryblock {
    grid-column: page;
  }

  .galleryblock-title {
    font-size: var(--fs-6);
    line-height: 112.5%;
    margin-bottom: var(--space-xl);
    font-weight: 500;
  }

  .galleryblock-grid {
    width: 100%;
  }

  @media (min-width: 1024px) {
    .galleryblock-grid {
      grid-template-columns: repeat(var(--grid-cols, 3), 1fr);
    }
  }

  .galleryblock-masonry {
    width: 100%;
  }

  @media (min-width: 1024px) {
    .galleryblock-masonry {
      column-count: var(--columns, 3);
    }
  }

  .galleryblock-item {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }

  .galleryblock-image {
    width: 100%;
    height: auto;
    display: block;
    /* border-radius: var(--radius-md, 4px); */
  }

  .galleryblock-caption {
    font-size: var(--fs--1);
    opacity: 0.7;
    font-weight: 400;
    line-height: 133%;
    
  }

  /* Break-inside avoid voor masonry */
  .break-inside-avoid {
    break-inside: avoid;
    page-break-inside: avoid;
  }
</style>

