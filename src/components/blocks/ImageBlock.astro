---
// Import Components & Scripts
import { Image } from 'astro:assets'
import { urlForImage } from '../../sanity/lib/image'
import type { SanityImage } from '../../sanity/types'

// Define Types
interface Props {
  size?: "inline" | "popout" | "feature" | "full" | "inherit";
  showCaption?: boolean;
  // Sanity props
  image?: SanityImage;
  alt?: string;
  title?: string;
  caption?: string;
}

// Define Vars
const { 
  size, 
  showCaption, 
  // Sanity props
  image,
  alt,
  title,
  caption
} = Astro.props;

// Generate image URL - Sanity data only
let finalSourceUrl = '';
let finalAltText = '';
let finalTitleText = '';
let finalCaptionText = '';

if (image?.asset) {
  try {
    finalSourceUrl = urlForImage(image)?.url() || '';
    finalAltText = image.alt || alt || '';
    finalTitleText = image.caption || title || '';
    finalCaptionText = image.caption || caption || '';
  } catch (error) {
    console.warn('Failed to generate image URL:', error);
  }
}

if (import.meta.env.DEV) {
  console.log('üñºÔ∏è ImageBlock received:', {
    sourceUrl: finalSourceUrl,
    size,
    altText: finalAltText,
    titleText: finalTitleText,
    showCaption,
    captionText: finalCaptionText,
    hasSanityImage: !!image
  });
}
---

<!--ImageBlock -->
{finalSourceUrl && 
<div class:list={['imageblock', size]}>
  <Image 
    src={finalSourceUrl}
    inferSize
    alt={finalAltText} 
    title={finalTitleText}
    class="imageblock-img"
  />
  {(showCaption || finalCaptionText) &&
    <p class="imageblock-caption" set:html={finalCaptionText} />
  }
</div>
}
<style>
  .imageblock-img {
    width: 100%;
    height: auto;
    display: block;
  }

  /* Size-based grid positioning */
  .imageblock.content {
    grid-column: content;
  }

  .imageblock.popout {
    grid-column: popout;
  }

  .imageblock.feature {
    grid-column: feature;
  }

  .imageblock.full {
    grid-column: full;
  }

  .imageblock.inline {
    grid-column: content;
  }

  .imageblock.inherit {
    grid-column: inherit;
  }
</style>