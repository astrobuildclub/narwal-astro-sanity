---
// Import Components & Scripts
import { Image } from 'astro:assets';
import { urlForImage } from '../../../sanity/lib/image';
import type { SanityImage } from '../../sanity/types';
import { cleanSize } from '../../lib/stega-clean';

// Define Types
interface Props {
  size?: 'content' | 'popout' | 'feature' | 'page' | 'full' | 'inherit';
  showCaption?: boolean;
  loading?: 'lazy' | 'eager';
  // Sanity props
  image?: SanityImage;
  alt?: string;
  title?: string;
  caption?: string;
}

// Define Vars
const {
  showCaption,
  loading = 'lazy',
  // Sanity props
  image,
  alt,
  title,
  caption,
} = Astro.props;
const size = cleanSize(Astro.props.size);

// Generate image URL - Sanity data only
let finalSourceUrl = '';
let finalAltText = '';
let finalTitleText = '';
let finalCaptionText = '';

// Map size to optimal width constraints
function getWidthForSize(size?: string): number {
  switch (size) {
    case 'content':
      return 800;
    case 'popout':
      return 1000;
    case 'feature':
      return 1200;
    case 'page':
      return 1400;
    case 'full':
      return 1920;
    default:
      return 1200; // Default voor content/unknown sizes
  }
}

// Calculate height based on width and standard aspect ratio (16:9)
function getHeightForWidth(width: number): number {
  return Math.round((width * 9) / 16);
}

let imageWidth = 1200;
let imageHeight = getHeightForWidth(imageWidth);

if (image?.asset) {
  try {
    imageWidth = getWidthForSize(size);
    imageHeight = getHeightForWidth(imageWidth);
    // Use quality 90 for project content images (higher quality, less compression)
    const imageBuilder = urlForImage(image, 90);

    if (size !== 'inherit') {
      // Voeg width constraint toe voor alle sizes behalve inherit
      finalSourceUrl = imageBuilder?.width(imageWidth).url() || '';
    } else {
      // Voor inherit, gebruik alleen base optimalisaties
      finalSourceUrl = imageBuilder?.url() || '';
    }

    finalAltText = image.alt || alt || '';
    finalTitleText = image.caption || title || '';
    finalCaptionText = image.caption || caption || '';
  } catch (error) {
    // Failed to generate image URL
  }
}
---

<!--ImageBlock -->{
  finalSourceUrl && (
    <div class:list={['imageblock', size]}>
      <Image
        src={finalSourceUrl}
        width={imageWidth}
        height={imageHeight}
        alt={finalAltText || ''}
        title={finalTitleText || undefined}
        loading={loading}
        class="imageblock-img"
      />
      {(showCaption || finalCaptionText) && (
        <p class="imageblock-caption" set:html={finalCaptionText} />
      )}
    </div>
  )
}
<style>
  .imageblock-img {
    width: 100%;
    height: auto;
    display: block;
  }

  /* Size-based grid positioning */
  .imageblock.content {
    grid-column: content;
  }

  .imageblock.popout {
    grid-column: popout;
  }

  .imageblock.feature {
    grid-column: feature;
  }

  .imageblock.page {
    grid-column: page;
  }

  .imageblock.full {
    grid-column: full;
  }

  .imageblock.inline {
    grid-column: content;
  }

  .imageblock.inherit {
    grid-column: inherit;
  }
</style>
