---
import { urlForImage } from '../../../sanity/lib/image';
import type { SanityVideoBlock } from '../../sanity/types';

// Define Types - following EmbedBlock structure
interface Props {
  video: SanityVideoBlock;
  size?: "content" | "inline" | "popout" | "feature" | "page" | "full" | "inherit";
}

// Define Vars
const { video, size } = Astro.props;

const {
  videoType = 'upload',
  id,
  title,
  params,
  thumbnail,
  ratio,
  autoscale = true,
  widget = false,
  size: videoSize = 'inline',
  videoFile,
  autoplay = false,
  loop = false,
  muted = true
} = video;

// Determine service from videoType
const service = videoType === 'youtube' ? 'youtube' : videoType === 'vimeo' ? 'vimeo' : undefined;

// Use size prop as fallback if video.size is not available
const finalSize = videoSize || size || 'inline';

// Generate thumbnail URL using @sanity/image-url
let thumbnailUrl = '';
if (thumbnail?.asset) {
  try {
    thumbnailUrl = urlForImage(thumbnail)?.width(1280).height(720).url() || '';
  } catch (error) {
    // Failed to generate thumbnail URL
  }
}

// Calculate aspect ratio CSS
const aspectRatioMap = {
  '1:1': '1/1',
  '2:1': '2/1', 
  '3:2': '3/2',
  '5:2': '5/2',
  '4:3': '4/3',
  '16:9': '16/9',
  '16:10': '16/10',
  '20:9': '20/9',
  '21:9': '21/9',
  '9:16': '9/16',
  '9:20': '9/20'
};

const aspectRatioCSS = ratio && aspectRatioMap[ratio] ? aspectRatioMap[ratio] : null;

// Generate video file URL
let videoFileUrl = '';
if (videoFile?.asset) {
  try {
    // For Sanity files, we need to construct the URL manually
    const assetId = videoFile.asset._ref.replace('file-', '').replace('-mp4', '');
    videoFileUrl = `https://cdn.sanity.io/files/${import.meta.env.PUBLIC_SANITY_PROJECT_ID}/${import.meta.env.PUBLIC_SANITY_DATASET}/${assetId}.mp4`;
  } catch (error) {
    // Failed to generate video file URL
  }
}

// Size class mapping - following EmbedBlock structure
function getSizeClass(size: string) {
  switch (size) {
    case "popout":
      return "popout";
    case "feature":
      return "feature";
    case "page":
      return "page";
    case "full":
      return "full";
    case "inherit":
      return "inherit";
    case "content":
      return "content";
    default:
      return "content";
  }
}

---

    <!-- VideoBlock - following EmbedBlock structure -->
    <section class={`video-container ${getSizeClass(finalSize)}`}>
      {videoType === 'upload' && videoFileUrl && (
        <!-- MP4 Upload Video -->
        <div 
          class="videoblock upload" 
          style={aspectRatioCSS ? `aspect-ratio: ${aspectRatioCSS};` : undefined}
        >
          <video
            controls
            preload="metadata"
            playsinline
            loop={loop}
            muted={muted}
            autoplay={autoplay}
            poster={thumbnailUrl}
            title={title || 'Video'}
          >
            <source src={videoFileUrl} type="video/mp4" />
            Your browser does not support the video tag.
          </video>
        </div>
      )}

      {(videoType === 'youtube' || videoType === 'vimeo') && id && (
        <!-- YouTube/Vimeo Embed with IframeManager - exact EmbedBlock structure -->
        <div
          class="embed"
          data-service={service}
          data-id={id}
          data-title={title || 'Video'}
          data-params={params ? `${params}&enablejsapi=1` : "enablejsapi=1"}
          data-thumbnail={thumbnailUrl}
          {...(ratio && ratio.trim() ? { 'data-ratio': ratio } : {})}
          data-autoscale={autoscale ? "" : undefined}
          data-widget={widget ? "" : undefined}
        >
        </div>
      )}

      {videoType === 'upload' && !videoFileUrl && (
        <!-- Fallback for missing video file -->
        <div class="videoblock error">
          <p>Video bestand niet gevonden</p>
        </div>
      )}

      {(videoType === 'youtube' || videoType === 'vimeo') && !id && (
        <!-- Fallback for missing video ID -->
        <div class="videoblock error">
          <p>Video ID niet gevonden</p>
        </div>
      )}
    </section>

<style>
  .video-container {
    width: 100%;
    /* Geen aspect-ratio hier - wordt per video type afgehandeld */
  }

  .videoblock {
    position: relative;
    width: 100%;
    overflow: hidden;
    border-radius: var(--radius-sm, 4px);
  }

  /* Video zonder aspect-ratio: gebruik natuurlijke hoogte */
  .videoblock.upload:not([style*="aspect-ratio"]) video {
    width: 100%;
    height: auto;
    display: block;
    margin: 0;
    padding: 0;
  }

  /* Video met aspect-ratio: gebruik cover */
  .videoblock.upload[style*="aspect-ratio"] video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    margin: 0;
    padding: 0;
  }

  .videoblock.error {
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f5f5f5;
    color: #666;
    text-align: center;
    padding: 2rem;
  }

  /* EmbedBlock structure - let iframemanager handle the styling */
  div[data-service],
  div[data-service] .cll,
  div[data-service] .cll a,
  div[data-service] .cll button {
  }

  /* Video embeds zonder data-ratio: gebruik natuurlijke aspect ratio */
  /* Overschrijf de default 16:9 aspect ratio van iframemanager */
  .video-container div[data-service]:not([data-ratio])::before {
    display: none !important;
    padding-top: 0 !important;
  }

  .video-container div[data-service]:not([data-ratio]) {
    min-height: auto;
  }

  .video-container div[data-service]:not([data-ratio]) .cll {
    position: relative;
  }

  .video-container div[data-service]:not([data-ratio]) .cll iframe {
    position: relative !important;
    width: 100% !important;
    height: auto !important;
    min-height: auto !important;
  }

  /* Size-based styling - following EmbedBlock pattern */
  .video-container.inline {
    grid-column: content;
  }

  .video-container.popout {
    grid-column: popout;
  }

  .video-container.feature {
    grid-column: feature;
  }

  .video-container.page {
    grid-column: page;
  }

  .video-container.full {
    grid-column: full;
  }

  .video-container.inherit {
    grid-column: inherit;
  }
</style>