---
import { urlForImage } from '../../sanity/lib/image';
import type { SanityVideoBlock } from '../../sanity/types';

// Define Types - following EmbedBlock structure
interface Props {
  video: SanityVideoBlock;
  size?: "inline" | "popout" | "feature" | "full" | "inherit";
}

// Define Vars
const { video, size } = Astro.props;

const {
  videoType = 'upload',
  id,
  title,
  params,
  thumbnail,
  ratio = '16:9',
  autoscale = true,
  widget = false,
  size: videoSize = 'inline',
  videoFile,
  autoplay = false,
  loop = false,
  muted = true
} = video;

// Determine service from videoType
const service = videoType === 'youtube' ? 'youtube' : videoType === 'vimeo' ? 'vimeo' : undefined;

// Use size prop as fallback if video.size is not available
const finalSize = videoSize || size || 'inline';

// Generate thumbnail URL - simple approach like ImageBlock.astro
let thumbnailUrl = '';
if (thumbnail?.asset?._ref) {
  try {
    const projectId = import.meta.env.PUBLIC_SANITY_PROJECT_ID;
    const dataset = import.meta.env.PUBLIC_SANITY_DATASET;
    
    if (projectId && dataset) {
      // Extract asset ID from reference - remove the existing dimensions
      const assetId = thumbnail.asset._ref
        .replace('image-', '')
        .replace(/-1280x720-jpg$|-1280x720-png$|-1280x720-webp$|-1280x720-gif$/, '')
        .replace(/-jpg$|-png$|-webp$|-gif$/, '');
      
      const extension = thumbnail.asset._ref.includes('-jpg')
        ? 'jpg'
        : thumbnail.asset._ref.includes('-png')
          ? 'png'
          : thumbnail.asset._ref.includes('-webp')
            ? 'webp'
            : 'jpg';
      
      // Generate URL with proper dimensions
      thumbnailUrl = `https://cdn.sanity.io/images/${projectId}/${dataset}/${assetId}-1280x720.${extension}`;
    }
  } catch (error) {
    console.warn('Failed to generate thumbnail URL:', error);
  }
}

// Calculate aspect ratio CSS
const aspectRatioMap = {
  '1:1': '1/1',
  '2:1': '2/1', 
  '3:2': '3/2',
  '5:2': '5/2',
  '4:3': '4/3',
  '16:9': '16/9',
  '16:10': '16/10',
  '20:9': '20/9',
  '21:9': '21/9',
  '9:16': '9/16',
  '9:20': '9/20'
};

const aspectRatioCSS = aspectRatioMap[ratio] || '16/9';

// Generate video file URL
let videoFileUrl = '';
if (videoFile?.asset) {
  try {
    // For Sanity files, we need to construct the URL manually
    const assetId = videoFile.asset._ref.replace('file-', '').replace('-mp4', '');
    videoFileUrl = `https://cdn.sanity.io/files/${import.meta.env.PUBLIC_SANITY_PROJECT_ID}/${import.meta.env.PUBLIC_SANITY_DATASET}/${assetId}.mp4`;
  } catch (error) {
    console.warn('Failed to generate video file URL:', error);
  }
}

// Size class mapping - following EmbedBlock structure
function getSizeClass(size: string) {
  switch (size) {
    case "popout":
      return "popout";
    case "feature":
      return "feature";
    case "full":
      return "full";
    case "inherit":
      return "inherit";
    default:
      return "inline";
  }
}

if (import.meta.env.DEV) {
  console.log('ðŸŽ¥ VideoBlock received:', {
    videoType,
    service: service || 'N/A',
    id,
    title: title || 'No title',
    hasVideoFile: !!videoFile,
    hasThumbnail: !!thumbnail,
    size: finalSize,
    thumbnailUrl,
    videoFileUrl,
    ratio,
    aspectRatioCSS
  });
  
  console.log('ðŸŽ¥ Thumbnail details:', {
    thumbnail,
    thumbnailAsset: thumbnail?.asset,
    thumbnailUrl,
    urlForImageResult: thumbnail?.asset ? urlForImage(thumbnail) : 'No thumbnail asset'
  });
}
---

    <!-- VideoBlock - following EmbedBlock structure -->
    <section class={`video-container ${getSizeClass(finalSize)}`} style={`aspect-ratio: ${aspectRatioCSS};`}>
      {videoType === 'upload' && videoFileUrl && (
        <!-- MP4 Upload Video -->
        <div class="videoblock upload">
          <video
            controls
            preload="metadata"
            playsinline
            loop={loop}
            muted={muted}
            autoplay={autoplay}
            poster={thumbnailUrl}
            title={title || 'Video'}
          >
            <source src={videoFileUrl} type="video/mp4" />
            Your browser does not support the video tag.
          </video>
        </div>
      )}

      {(videoType === 'youtube' || videoType === 'vimeo') && id && (
        <!-- YouTube/Vimeo Embed with IframeManager - exact EmbedBlock structure -->
        <div
          class="embed"
          data-service={service}
          data-id={id}
          data-title={title || 'Video'}
          data-params={params ? `${params}&enablejsapi=1` : "enablejsapi=1"}
          data-thumbnail={thumbnailUrl}
          data-ratio={ratio}
          data-autoscale={autoscale ? "" : undefined}
          data-widget={widget ? "" : undefined}
        >
        </div>
      )}

      {videoType === 'upload' && !videoFileUrl && (
        <!-- Fallback for missing video file -->
        <div class="videoblock error">
          <p>Video bestand niet gevonden</p>
        </div>
      )}

      {(videoType === 'youtube' || videoType === 'vimeo') && !id && (
        <!-- Fallback for missing video ID -->
        <div class="videoblock error">
          <p>Video ID niet gevonden</p>
        </div>
      )}
    </section>

<style>
  .video-container {
    width: 100%;
    background-color: #333;
  }

  .videoblock {
    position: relative;
    width: 100%;
    overflow: hidden;
    border-radius: var(--radius-sm, 4px);
  }

  .videoblock.upload video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .videoblock.error {
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f5f5f5;
    color: #666;
    text-align: center;
    padding: 2rem;
  }

  /* EmbedBlock structure - let iframemanager handle the styling */
  div[data-service],
  div[data-service] .cll,
  div[data-service] .cll a,
  div[data-service] .cll button {
  }

  /* Size-based styling - following EmbedBlock pattern */
  .video-container.inline {
    grid-column: content;
  }

  .video-container.popout {
    grid-column: popout;
  }

  .video-container.feature {
    grid-column: feature;
  }

  .video-container.full {
    grid-column: full;
  }

  .video-container.inherit {
    grid-column: inherit;
  }
</style>