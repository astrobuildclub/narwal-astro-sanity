---
import { urlForImage } from '../../../sanity/lib/image';
import type { SanityVideoBlock } from '../../sanity/types';
import { cleanSize } from '../../lib/stega-clean';

// Define Types - following EmbedBlock structure
interface Props {
  video: SanityVideoBlock;
  size?: "content" | "inline" | "popout" | "feature" | "page" | "full" | "inherit";
}

// Define Vars
const { video, size } = Astro.props;

const {
  videoType = 'upload',
  id,
  title,
  thumbnail,
  ratio,
  autoscale = true,
  widget = false,
  size: videoSize = 'page',
  videoFile,
  autoplay = true,
  loop = true,
  muted = true,
  directUrl,
  caption,
  controls = true
} = video;

// Type guard for videoType to help TypeScript
const currentVideoType: 'upload' | 'youtube' | 'vimeo' | 'direct' = videoType || 'upload';

// Determine service from videoType
const service = currentVideoType === 'youtube' ? 'youtube' : currentVideoType === 'vimeo' ? 'vimeo' : undefined;

// Use size prop as fallback if video.size is not available
// Clean stega characters from size values
const cleanedVideoSize = cleanSize(videoSize);
const cleanedSize = cleanSize(size);
const finalSize = cleanedVideoSize || cleanedSize || 'page';

// Generate embed parameters from toggles for YouTube/Vimeo
function generateEmbedParams(autoplay: boolean, muted: boolean, loop: boolean): string {
  const params: string[] = [];
  if (autoplay) params.push('autoplay=1');
  if (muted) params.push('mute=1');
  if (loop) params.push('loop=1');
  params.push('enablejsapi=1');
  return params.join('&');
}

const embedParams = (currentVideoType === 'youtube' || currentVideoType === 'vimeo') 
  ? generateEmbedParams(autoplay, muted, loop)
  : '';

// Generate thumbnail URL using @sanity/image-url
let thumbnailUrl = '';
if (thumbnail?.asset) {
  try {
    thumbnailUrl = urlForImage(thumbnail)?.width(1280).height(720).url() || '';
  } catch (error) {
    // Failed to generate thumbnail URL
  }
}

// Calculate aspect ratio CSS
const aspectRatioMap = {
  '1:1': '1/1',
  '2:1': '2/1', 
  '3:2': '3/2',
  '5:2': '5/2',
  '4:3': '4/3',
  '16:9': '16/9',
  '16:10': '16/10',
  '20:9': '20/9',
  '21:9': '21/9',
  '9:16': '9/16',
  '9:20': '9/20',
  '3:4': '3/4',
  '4:5': '4/5',
  '5:4': '5/4'
};

const aspectRatioCSS = ratio && aspectRatioMap.hasOwnProperty(ratio) ? aspectRatioMap[ratio] : '16/9';

// Generate video file URL
let videoFileUrl = '';
if (videoFile && videoFile.asset && typeof videoFile.asset._ref === 'string') {
  try {
    // For Sanity files, we need to construct the URL manually
    const assetId = videoFile.asset._ref.replace('file-', '').replace('-mp4', '');
    videoFileUrl = `https://cdn.sanity.io/files/${import.meta.env.PUBLIC_SANITY_PROJECT_ID}/${import.meta.env.PUBLIC_SANITY_DATASET}/${assetId}.mp4`;
  } catch (error) {
    // Failed to generate video file URL
  }
}

// Size class mapping - following EmbedBlock structure
function getSizeClass(size: string) {
  switch (size) {
    case "popout":
      return "popout";
    case "feature":
      return "feature";
    case "page":
      return "page";
    case "full":
      return "full";
    case "inherit":
      return "inherit";
    case "content":
      return "content";
    default:
      return "content";
  }
}

---

    <!-- VideoBlock - following EmbedBlock structure -->
    <section class={`video-container ${getSizeClass(finalSize)}`}>
      {currentVideoType === 'upload' && videoFileUrl && (
        <!-- MP4 Upload Video -->
        <div class="videoblock upload" style={`aspect-ratio: ${aspectRatioCSS};`}>
          <video
            controls={controls ? true : undefined}
            preload="metadata"
            playsinline
            loop={loop}
            muted={muted}
            autoplay={autoplay}
            poster={thumbnailUrl}
            title={title || 'Video'}
          >
            <source src={videoFileUrl} type="video/mp4" />
            Your browser does not support the video tag.
          </video>
        </div>
      )}

      {currentVideoType === 'direct' && directUrl && (
        <!-- Direct URL Video -->
        <div class="videoblock direct" style={`aspect-ratio: ${aspectRatioCSS};`}>
          <video
            controls={controls ? true : undefined}
            preload="metadata"
            playsinline
            loop={loop}
            muted={muted}
            autoplay={autoplay}
            poster={thumbnailUrl}
            title={title || 'Video'}
          >
            <source src={directUrl} type="video/mp4" />
            Your browser does not support the video tag.
          </video>
        </div>
      )}

      {(currentVideoType === 'youtube' || currentVideoType === 'vimeo') && id && (
        <!-- YouTube/Vimeo Embed with IframeManager - exact EmbedBlock structure -->
        <div
          class="embed"
          data-service={service}
          data-id={id}
          data-title={title || 'Video'}
          data-params={embedParams}
          data-thumbnail={thumbnailUrl}
          data-ratio={ratio}
          data-autoscale={autoscale ? "" : undefined}
          data-widget={widget ? "" : undefined}
        >
        </div>
      )}

      {currentVideoType === 'upload' && !videoFileUrl && (
        <!-- Fallback for missing video file -->
        <div class="videoblock error">
          <p>Video bestand niet gevonden</p>
        </div>
      )}

      {currentVideoType === 'direct' && !directUrl && (
        <!-- Fallback for missing direct URL -->
        <div class="videoblock error">
          <p>Video URL niet gevonden</p>
        </div>
      )}

      {(currentVideoType === 'youtube' || currentVideoType === 'vimeo') && !id && (
        <!-- Fallback for missing video ID -->
        <div class="videoblock error">
          <p>Video ID niet gevonden</p>
        </div>
      )}

      {caption && (
        <!-- Caption -->
        <p class="video-caption">{caption}</p>
      )}
    </section>

<style>
  .video-container {
    width: 100%;
    /* Geen aspect-ratio hier - wordt per video type afgehandeld */
  }

  .videoblock {
    position: relative;
    width: 100%;
    overflow: hidden;
    border-radius: var(--radius-sm, 4px);
  }

  .videoblock.upload video,
  .videoblock.direct video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    margin: 0;
    padding: 0;
  }

  .videoblock.error {
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f5f5f5;
    color: #666;
    text-align: center;
    padding: 2rem;
  }

  /* EmbedBlock structure - let iframemanager handle the styling */
  div[data-service],
  div[data-service] .cll,
  div[data-service] .cll a,
  div[data-service] .cll button {
  }

  /* Size-based styling - following EmbedBlock pattern */
  .video-container.inline {
    grid-column: content;
  }

  .video-container.popout {
    grid-column: popout;
  }

  .video-container.feature {
    grid-column: feature;
  }

  .video-container.page {
    grid-column: page;
  }

  .video-container.full {
    grid-column: full;
  }

  .video-container.inherit {
    grid-column: inherit;
  }

  .video-caption {
    margin-top: var(--space-s, 0.5rem);
    font-size: 0.875rem;
    color: var(--color-text-secondary, #666);
    text-align: center;
  }
</style>