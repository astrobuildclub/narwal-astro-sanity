---
import '../assets/global.css';
import '../assets/scss/globals.scss';
import '../assets/default.css';
import SiteMeta from '../components/SiteMeta.astro';
import SiteNavigation from '../components/SiteNavigation.astro';
import SiteFooter from '../components/SiteFooter.astro';
import CookieConsent from '../components/CookieConsent.astro';
import DarkMode from '../components/DarkMode.astro';
import { VisualEditing } from '@sanity/astro/visual-editing';

import { getNavigation } from '../lib/sanity';

type Props = {
  children?: any;
  title: string;
  description?: string;
  image?: any;
  author?: any;
  seo?: any;
  url?: string;
};

const {
  title,
  description,
  image = '/social-preview-image.png',
  author = 'AstroBuildClubâ„¢',
  seo,
  url,
} = Astro.props;
const { menus, generalSettings } = await getNavigation();
const primaryMenu = menus.nodes[0];

// Visual Editing support
// Check environment variable (eerste prioriteit)
const envVisualEditingEnabled =
  import.meta.env.PUBLIC_SANITY_VISUAL_EDITING_ENABLED === 'true';

// Check URL parameter als fallback (voor productie)
// Gebruik Astro.request.url voor query parameters in SSR mode
const requestUrl = new URL(Astro.request.url);
const urlPreviewEnabled = requestUrl.searchParams.get('preview') === 'true';

// Visual editing enabled wanneer:
// - Environment variable is true, OF
// - URL parameter preview=true is aanwezig
const visualEditingEnabled = envVisualEditingEnabled || urlPreviewEnabled;

// Debug logging (uitgecomment - alleen nodig bij troubleshooting)
// if (import.meta.env.DEV && seo) {
//   console.log('ðŸŽ¯ Layout SEO:', { title: seo.title?.substring(0, 30), url });
// }
---

<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <script is:inline>
      // Carry current theme into the incoming document before swap
      document.addEventListener('astro:before-swap', (event) => {
        try {
          const theme =
            localStorage.getItem('theme') ||
            document.documentElement.getAttribute('data-theme') ||
            'light';
          event.newDocument.documentElement.setAttribute('data-theme', theme);
        } catch (e) {}
      });
    </script>
    <script is:inline>
      (function () {
        try {
          const doc = document.documentElement;
          const stored = localStorage.getItem('theme');
          const prefersDark = window.matchMedia(
            '(prefers-color-scheme: dark)',
          ).matches;
          const theme = stored || (prefersDark ? 'dark' : 'light');
          doc.setAttribute('data-theme', theme);
        } catch (e) {}
      })();
    </script>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />

    <!-- Font imports -->
    <link rel="stylesheet" href="https://use.typekit.net/yjz0kgm.css" />

    <!-- CookieConsent CSS -->

    <!-- CookieConsent CSS -->
    <link rel="stylesheet" href="/css/iframemanager.css" />
    <link rel="stylesheet" href="/css/cookieconsent.css" />

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/orestbida/cookieconsent@v3.0.1/dist/cookieconsent.css"
    />

    <SiteMeta
      title={seo?.title || title}
      description={seo?.description || description}
      url={seo?.canonicalUrl ||
        url ||
        (Astro.site ? Astro.site.toString() : 'https://accessible-astro.dev')}
      image={seo?.metaImage || seo?.openGraph?.image || image}
      author={author}
      seo={seo}
    />
  </head>

  <body>
    <SiteNavigation menu={primaryMenu} generalSettings={generalSettings} />
    <main class="page-layout md:mb-[100vh]">
      <slot />
    </main>
    <SiteFooter />
    <CookieConsent />
    <DarkMode />
    <VisualEditing enabled={visualEditingEnabled} />
    <!-- JavaScript bestanden -->
    <script src="/js/cookieconsent.umd.js" is:inline></script>
    <script src="/js/iframemanager.js" is:inline></script>
    <script is:inline>
      // Re-scan embeds after Astro view transitions
      const __rescanEmbeds = () => {
        try {
          window.iframemanager &&
            window.iframemanager.scan &&
            window.iframemanager.scan();
        } catch (e) {}
      };
      document.addEventListener('astro:page-load', __rescanEmbeds);
      document.addEventListener('astro:after-swap', __rescanEmbeds);
    </script>
    <script is:inline>
      // Keep muted autoplay videos playing when other videos start
      (function() {
        function keepMutedVideosPlaying() {
          // Find all muted autoplay videos
          const mutedAutoplayVideos = Array.from(document.querySelectorAll('video')).filter(video => {
            return video.muted && video.autoplay && video.loop;
          });

          if (mutedAutoplayVideos.length === 0) return;

          // Listen for play events on all videos
          document.addEventListener('play', function(e) {
            const playingVideo = e.target;
            
            // If the playing video is not muted, resume all muted autoplay videos
            if (playingVideo && playingVideo.tagName === 'VIDEO' && !playingVideo.muted) {
              mutedAutoplayVideos.forEach(video => {
                if (video !== playingVideo && video.paused) {
                  video.play().catch(() => {
                    // Ignore play errors (e.g., user interaction required)
                  });
                }
              });
            }
          }, true);

          // Also handle pause events - if a muted video gets paused, try to resume it
          mutedAutoplayVideos.forEach(video => {
            video.addEventListener('pause', function() {
              // Only resume if it's still muted and should be autoplaying
              if (this.muted && this.autoplay && this.loop) {
                // Small delay to avoid conflicts
                setTimeout(() => {
                  if (this.paused && this.muted) {
                    this.play().catch(() => {
                      // Ignore play errors
                    });
                  }
                }, 100);
              }
            });
          });
        }

        // Run on page load
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', keepMutedVideosPlaying);
        } else {
          keepMutedVideosPlaying();
        }

        // Re-run after Astro view transitions
        document.addEventListener('astro:page-load', keepMutedVideosPlaying);
        document.addEventListener('astro:after-swap', keepMutedVideosPlaying);
      })();
    </script>
  </body>
</html>

<style>
  main {
    padding-bottom: 20vh;
    background-color: var(--white);
    position: relative;
    z-index: 1;
  }

  /* Dark mode support */
  :root[data-theme='dark'] main {
    background-color: var(----clr-black: rgba(12, 12, 12) ;);
  }
</style>
