---
import DefaultLayout from "../layouts/DefaultLayout.astro";
import { getNodeData, getTemplateByRoute } from "../lib/routes";
import { getSiteSettings } from '../lib/sanity';
import { getSeoData } from '../lib/seo-helpers';

// SSR mode voor Visual Editing support
export const prerender = false;

// Dynamische parameter ophalen
const { uri } = Astro.params;
const slug = uri ? `/${uri}/` : "/";

// Haal searchParams op voor Visual Editing (preview mode)
const requestUrl = new URL(Astro.request.url);
const searchParams = requestUrl.searchParams;

let node = await getNodeData(slug, searchParams);
const Template = getTemplateByRoute(node);

// Haal site settings op voor SEO fallbacks
const siteSettings = await getSiteSettings();

// Build URL voor deze pagina
const pageUrl = Astro.site
  ? `${Astro.site}${slug === '/' ? '' : slug}`
  : `https://accessible-astro.dev${slug === '/' ? '' : slug}`;

// Get SEO data met fallbacks
const seoData = getSeoData(
  node.seo,
  siteSettings,
  node.title,
  'Our amazing studio from Rotterdam',
  pageUrl
);

// Debug logging (uitgecomment - alleen nodig bij troubleshooting)
// if (import.meta.env.DEV) {
//   console.log('ðŸ“Š Page:', { slug, hasSeo: !!node.seo, seoKeys: node.seo ? Object.keys(node.seo) : [] });
// }
---

<DefaultLayout
  title={seoData.title}
  description={seoData.description}
  seo={seoData}
  url={pageUrl}
>
  <Template data={node} />
</DefaultLayout>